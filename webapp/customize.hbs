<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sketchfab Viewer API example</title>
	<!-- Insert this script -->
	<script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.3.1.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<style>
		body{
    background: black;
    }
    .structural-head{
    background: #0da6e0;
    }
    .structural-head a, .model-specific label{
    color: #fff;
    font-weight: 100;
    }
    .navbar-nav.structural-h2{
    float:none;
    }
    .structural-h2 li{
    width: 13%;
    }
    .structural-h2 li a{
    color:#00a1de;
    }
    .brand{
    background-image: url("./images/airfrance-klm.jpg");
    height: 42px;
    width: 100px;
    background-size: 89%;
    background-repeat: no-repeat;
    background-position: 13px 4px;)
    }
	.nav-sdm{
	background: #0da6e0;
	border-radius: 6px;
	padding: 8px;
	}
	.klmbackground-img{
	/*background-image: url('https://c1.staticflickr.com/6/5608/15554800256_07ae878e08_b.jpg');*/
	background-repeat: no-repeat;
	background-size: cover;
	background: black;
	background-image: linear-gradient(black,#3d463d);
	}
	.nav-sdm a.navbar-brand strong, {
	color:#ffff;
	font-weight: 100;
	}
	.card, #annoName, #annoDescr{
    border-color: #00a1de;
	color: #828180;
	}
	.btn.disabled, .btn:disabled {
	opacity: .65;
	color: #fff;
	background-color: #e77b2f;
	box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.12);
	border: solid 1px #e77b2f;
	}
	h1.flight-details{
	color:#fff;
	font-size: 40px;
	}
	row .pt-3{
	padding-top: 3% !important;
	}
	h3{
	font-weight: 300;
	}
	.g-legal-footer{
    margin-top: 1px;
    background-color: #FFF;
    padding: 10px 0;
    text-align: center;
	}
	.klm-img{
	background-image: url('	https://kassa.bnnvara.nl/data/image/i/33000/mod_media_image/33297.w400.r400-225.b78ee01.png');
	background-repeat: no-repeat;
	height: 49px;
    width: 117px;
    background-size: 100%;
	}
	.pad-border{
	border-right: 1px solid #eaeaea;
    padding-right: 18px;
	}
	iframe{
	border: none;
	width:100%;
	}
	#markAnno{
	position: absolute;
    right: 8%;
    bottom: 11%;
    width: 16%;
    color: #ffff;
    background-color: #e77b2f;
    box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.12);
    border: solid 1px #e77b2f;;
	}
	.mt-10{
	margin-top:10px;
	}
	.mt-0{
	margin-top:0px;
	}
	.mb-0{
	margin-bottom:0px;
	}
	.btn-klm{
	width: 20%;
    color: #ffff;
    background-color: #e77b2f;
    box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.12);
    border: solid 1px #e77b2f;
    border-radius: 4px;
    padding: 2%;
	}
	.head-sdr{   
	padding-top: 15px;
    padding-bottom: 15px;
    line-height: 28px;
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #ffff;
	}
	@media screen and (max-width: 600px) {
	  .structural-head div ul:nth-of-type(2){
	  	display: none;
	  }
	  .structural-head div ul li{
	  	float: left;
	  }
	  .structural-head div ul li:nth-of-type(1){
	  	margin-left: 16%;
	  }
	  .structural-head div ul li:nth-of-type(2){
	  	font-size: 22px;
	  }
	  nav.navbar.panel{
	  	display:none;
	  }
	}
	</style>
</head>

<body>


	<!-- Main navigation -->
	<header>
		<nav class="structural-head">
			<div class="container-fluid">
				<ul class="nav navbar-nav">
					<li class="active klm-img"></li>
					<li>
						<div class="head-sdr">Structural Defect Reporting</div>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li>
						<div class="head-sdr">FAQ</div>
					</li>
					<li>
						<div class="head-sdr"> English</div>
					</li>
				</ul>
			</div>
		</nav>
	</header>
	<!--start of Tabs-->
	<nav class="navbar panel">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand brand" href="#"></a>
			</div>
			<ul class="nav navbar-nav structural-h2">
				<li class="active"><a href="#">Defects</a></li>
				<li><a href="#">Maintenance</a></li>
				<li><a href="#">Organisation</a></li>
				<li><a href="#">Processs & Tools</a></li>
				<li class="text-center"><a href="#">Library</a></li>

				<li class="pull-right"><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
			</ul>
		</div>
	</nav>
	<!--End of Tabs-->
	<!--start of model specifications-->
	<div class="model-specific">
		<div class="form-group col-md-3">
			<label for="aircraftmodel">Aircraft Model</label>
			<select class="form-control" id="aircraftmodel">
				<option>Boeing 737-900</option>
				<option>Boeing 737NG</option>
				<option>Boeing 747-400</option>
				<option>Boeing 737-800</option>
			</select>
		</div>
		<div class="form-group col-md-3">
			<label for="airline">Airlines</label>
			<select class="form-control" id="airline">
				<option>KLM</option>
				<option>Air France</option>
				<option>Jet Airways</option>
				<option>Delta</option>
			</select>
		</div>
		<div class="form-group col-md-3">
			<label for="registration">Registration Code</label>
			<select class="form-control" id="registration">
				<option>PH-BCA</option>
				<option>PH-AAA</option>
				<option>PH-ZCA</option>
				<option>ZH-BCA</option>
			</select>
		</div>
		<button class="btn btn-indigo" id="loadModel">Load</button>
		<!-- Navbar -->
		<!-- Full Page Intro -->
		{{!-- <div class="view" style="background-image: url('https://mdbootstrap.com/img/Photos/Others/images/31.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center center;">
			<!-- Mask & flexbox options--> --}}
			<div class=" klmbackground-img mask rgba-indigo-strong d-flex justify-content-center align-items-center">
				<!-- Content -->
				<div class="container">
					<!--Grid row-->
					<div class="row mt-lg-5">
						<!--Grid column-->
						<div class="col-md-9 pt-3 mb-5 mt-md-0 mt-5 white-text text-center text-md-left wow fadeInLeft" data-wow-delay="0.3s">
							<h6 class="mb-3 iframe-height">
								<iframe src="" id="api-frame" height="500" width="500"></iframe>
							</h6>
							<button class="btn btn-indigo" id="markAnno">Mark</button>
						</div>
						<!--Grid column-->
						<!--Grid column-->
						<div class="col-md-3 col-xl-5 mb-4">
							<!--Form-->
							<div class="card wow fadeInRight" data-wow-delay="0.3s">
								<div class="card-body z-depth-2">
									<!--Header-->
									<div class="text-center">
										<h3 class="dark-grey-text">
											<strong>Defect Reporting</strong>
										</h3>
										<hr>
									</div>
									<div class="md-form">
										<i class="fa fa-user prefix grey-text"></i>
										<label for="annoName">Damage Area</label>
										<input type="text" id="annoName" class="form-control">
									</div>
									<div class="md-form">
										<i class="fa fa-envelope prefix grey-text"></i>
										<label for="annoDescr">Description</label>
										<input type="text" id="annoDescr" class="form-control">
									</div>

									<label class="lead mt-10 mb-0">Contacts</label>
									<hr class="mt-0">
									<div>
										<i class="fa fa-envelope prefix grey-text"></i>
										<label>User</label>
										<input type="text" id="userName" class="form-control">
									</div>
									<div>
										<i class="fa fa-envelope prefix grey-text"></i>
										<label>Date</label>
										<input type="text" id="dateText" class="form-control">
									</div>
									<div>
										<i class="fa fa-envelope prefix grey-text"></i>
										<label>Hanger Location</label>
										<input type="text" id="hangerLocation" class="form-control">
									</div>

									<!--Textarea with icon prefix-->

									<div class="text-center mt-10 mt-3">
										<button class="btn-klm" id="saveAnno" disabled=true>Save</button>

										<hr>
										<small id="annoRes" class="form-text text-muted" style="display: none; color: green">Saved Successfully</small>
									</div>
								</div>
							</div>
							<!--/.Form-->
						</div>
						<!--Grid column-->
					</div>
					<!--Grid row-->
				</div>
				<!-- Content -->
			</div>
			<!-- Mask & flexbox options-->
		</div>
		<!-- Full Page Intro -->

		<footer>
			<div class="g-legal-footer">
				<div class="g-grid--row">
					<a href="https://www.klm.com/travel/nl_nl/meta/sitemap/sitemap.htm" target="_self">Site map</a>

					<a href="https://www.klm.com/travel/nl_nl/customer_support/customer_support/legal_information/index.htm" target="_self">Juridische
						informatie</a>

					<a href="https://www.klm.com/travel/nl_nl/customer_support/copyright_klm/index.htm" target="_self">Â© 2018 KLM</a>
				</div>
			</div>
		</footer>
		<!-- Main navigation -->

		<!-- Initialize the viewer -->
		<script type="text/javascript">
			var annolist = [];
			var modelsList = [];
			var addDefectMode = false;
			currentAnnotationToCreate = {};
			markDefectMode = false;
			cameraX = 0;
			cameraY = 0;
			cameraZ = 0;
			targetX = 0;
			targetY = 0;
			targetZ = 0;
			positionX = 0;
			positionY = 0;
			positionZ = 0;
			normalX = 0;
			normalY = 0;
			normalZ = 0;
			var currentAircraftmodelSelected;
			var currentAirlineSelected;
			var currentRegistrationCodeSelected;
			var cameraPosition;
			var cameraTarget;
			var currentDefectToUpdate;
			var currentAnnotationToUpdate;
			var sketchFabAPI;
			var iframe = document.getElementById('api-frame');
			var urlid = 'dbf6450b82a4461c9393dda70fb66a43';
			// By default, the latest version of the viewer API will be used.
			var client = new Sketchfab(iframe);

			// Controls
			document.getElementById('markAnno').addEventListener('click', function () {
				markDefectMode = true;
				clearForm();
			});
			document.getElementById('loadModel').addEventListener('click', function () {
				onLoadmodel();
			});
			$('#loadAnno').click(function () {
				init();
			});
			// API
			function onSuccess(api) {
				sketchFabAPI = api;
				api.addEventListener('annotationSelect', function (index) {
					if (index != -1) {
						api.getAnnotation(index, function (err, info) {
							if (info) {
								currentAnnotationToUpdate = info;
								currentDefectToUpdate = getAnnotationDetails((info.order - 1));
								setFormDetails(currentDefectToUpdate);
							}
						});
					}
				});
				api.addEventListener('click', function (info) {
					if (info.position2D !== null && markDefectMode) {
						markDefectMode = false;
						positionX = info.position3D[0];
						positionY = info.position3D[1];
						positionZ = info.position3D[2];
						normalX = info.normal[0];
						normalY = info.normal[1];
						normalZ = info.normal[2];
						api.getCameraLookAt(function (err, camera) {
							cameraPosition = camera.position;
							cameraTarget = camera.target;
							document.getElementById('saveAnno').disabled = false;
							document.getElementById('annoRes').style.display = "hidden";
							currentAnnotationToCreate = {
								pox: positionX,
								poy: positionY,
								poz: positionZ,
								nox: normalX,
								noy: normalY,
								noz: normalZ,
								camPos: cameraPosition,
								camTarget: cameraTarget,
								title: 'Title',
								content: 'Description',
								user: 'User',
								date: '10/18/2018',
								hangerLocation: 'HangerLocation'
							};
							var modelDetails;
							api.createAnnotation(
								[currentAnnotationToCreate.pox, currentAnnotationToCreate.poy, currentAnnotationToCreate.poz],
								[currentAnnotationToCreate.nox, currentAnnotationToCreate.noy, currentAnnotationToCreate.noz],
								currentAnnotationToCreate.camPos,
								currentAnnotationToCreate.camTarget,
								currentAnnotationToCreate.title,
								currentAnnotationToCreate.content,
								function (index) {
									api.updateAnnotation(index, {
										title: currentAnnotationToCreate.title,
										content: currentAnnotationToCreate.content
									});
									currentAnnotationToUpdate = currentAnnotationToCreate;
									var copiedObject = jQuery.extend(true, {}, currentAnnotationToCreate)
									checkForModel(copiedObject);
								}
							);
							//modelsList.push(modelDetails);
							//setFormDetails(currentAnnotationToCreate);
						});
					}
				}, {
					pick: 'fast'
				});
				api.start(function () {
					console.log('started');
					document.getElementById('saveAnno').addEventListener('click', function () {
						currentDefectToUpdate.title = $('#annoName').val();
						currentDefectToUpdate.content = $('#annoDescr').val();
						currentDefectToUpdate.hangerLocation = $('#hangerLocation').val();
						currentDefectToUpdate.date = $('#dateText').val();
						currentDefectToUpdate.user = $('#userName').val();
						api.updateAnnotation(currentAnnotationToUpdate.order, {
							title: currentDefectToUpdate.title,
							content: currentDefectToUpdate.content
						});
					});

					api.addEventListener('viewerready', function () {
						getModelsDetails();
						var currentModel = modelsList.filter(obj => {
							return (obj.aircraftmodel === currentAircraftmodelSelected && obj.airline === currentAirlineSelected &&
								obj.registrationCode === currentRegistrationCodeSelected)
						});
						if (currentModel.length != 0) {
							currentModel[0].defectsDetails.forEach(function (obj) {
								console.log('inside create', obj)
								api.createAnnotation(
									[obj.pox, obj.poy, obj.poz],
									[obj.nox, obj.noy, obj.noz],
									obj.camPos,
									obj.camTarget,
									obj.title,
									obj.content,
									function (index) {
										// console.log('added hotspot: ' + index);
										// api.removeAnnotation(index);
									}
								);
							});
						}
					});
				});
			};
			// Methods
			function getAnnotationDetails(index) {
				var currentModel = modelsList.filter(obj => {
					return (obj.aircraftmodel === currentAircraftmodelSelected && obj.airline === currentAirlineSelected && obj.registrationCode ===
						currentRegistrationCodeSelected)
				});
				return currentModel[0].defectsDetails[index];
			}

			function checkForModel(annotationToAdd) {
				var currentModel = modelsList.filter(obj => {
					return (obj.aircraftmodel === currentAircraftmodelSelected && obj.airline === currentAirlineSelected && obj.registrationCode ===
						currentRegistrationCodeSelected)
				});
				if (currentModel.length === 0) {
					modelDetails = {
						aircraftmodel: currentAircraftmodelSelected,
						airline: currentAirlineSelected,
						registrationCode: currentRegistrationCodeSelected,
						defectsDetails: [annotationToAdd]
					};
					currentDefectToUpdate = modelDetails;
					modelsList.push(modelDetails);
				} else {
					currentDefectToUpdate = currentModel[0];
					currentModel[0].defectsDetails.push(annotationToAdd);
				}
			};

			function clearForm() {
				$('#annoName').val('');
				$('#annoDescr').val('');
				$('#hangerLocation').val('');
				$('#dateText').val('');
				$('#userName').val('');
				sketchFabAPI.unselectAnnotation();
				document.getElementById('saveAnno').disabled = true;
			};

			function setFormDetails(info) {
				if (info) {
					$('#annoName').val(info.title);
					$('#annoDescr').val(info.content);
					$('#hangerLocation').val(info.hangerLocation);
					$('#dateText').val(info.date);
					$('#userName').val(info.user);
				}
			};

			function onLoadmodel() {
				clearForm();
				getModelsDetails();
				document.getElementById('api-frame').src += '';
				client = new Sketchfab(document.getElementById('api-frame'));
				//document.getElementById('api-frame').contentWindow.location.reload();
				client.init(urlid, {
					success: onSuccess,
					error: onError,
					annotation: 0,
					annotations_visible: 1,
					ui_controls: 0

				});
			};

			function onError(error) {
				console.log(error);
			};

			function getModelsDetails() {
				currentAircraftmodelSelected = $('#aircraftmodel').val();
				currentAirlineSelected = $('#airline').val();
				currentRegistrationCodeSelected = $('#registration').val();
			};

			function init() {
				if (modelsList.length === 0) {
					modelDetails = {
						aircraftmodel: currentAircraftmodelSelected,
						airline: currentAirlineSelected,
						registrationCode: currentRegistrationCodeSelected,
						defectsDetails: []
					};
					modelsList.push(modelDetails);
					client.init(urlid, {
						success: onSuccess,
						error: onError,
						annotation: 0,
						annotations_visible: 1,
						ui_controls: 0

					});
				}
			};
			init();
		</script>

</body>

</html>